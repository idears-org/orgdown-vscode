# Org Mode TextMate Grammar Template
# This file contains placeholders that will be replaced by build-grammar.ts
# Edit src/grammar/regex.ts for regex patterns, not this file

fileTypes: [org]
name: Org Mode
scopeName: text.org
patterns:
  - { include: '#block' }
repository:
  block:
    patterns:
      - { include: '#headings' }
      - { include: '#lists' }
      # - { include: '#comments' }
      # - { include: '#keywords' }
      # - { include: '#org-special-blocks' }
      - { include: '#org-src-blocks' }
      # - { include: '#drawers' }
      # - { include: '#horizontal-rules' }
      # - { include: '#tables' }
      # - { include: '#footnotes' }
      # - { include: '#paragraph' }

  #region HEADLINES
  # Anchor: Common capture groups for Org headlines.
  # Each group corresponds to a semantic part of a headline line.
  # 1: Leading stars (headline level)
  # 2: TODO keyword (if present)
  # 3: Priority marker (e.g. [#A])
  # 4: Priority value
  # 5: Headline title (supports inline markup)
  # 6: Progress indicator (e.g. [50%])
  # 7: Tags (e.g. :tag1:tag2:)
  heading-captures: &heading-captures # See above for group meaning
    1: { name: punctuation.definition.heading.org }
    2: { name: keyword.other.todo.org }
    3: { name: constant.other.priority.org }
    4: { name: constant.other.priority.value.org }
    5:
      name: entity.name.section.org
      patterns:
        - include: "#inline-markup"
    6: { name: constant.other.progress.org }
    7: { name: entity.name.tag.org }

  # Headings: Two-layer Org headline parsing.
  # First layer: headlineDetectRegex matches any headline line and captures the whole line.
  # Second layer: In the first capture group, patterns match specific headline levels (1-6) and extract semantic parts using heading-captures.
  headings:
    match: "{{headlineDetectRegex}}"
    name: markup.heading.org
    captures:
      '1':
        patterns:
          # Each pattern below matches a specific Org headline level and applies semantic captures.
          - name: heading.1.org
            match: "{{headlineLevel1Regex}}"
            captures:
              <<: *heading-captures
          - name: heading.2.org
            match: "{{headlineLevel2Regex}}"
            captures:
              <<: *heading-captures
          - name: heading.3.org
            match: "{{headlineLevel3Regex}}"
            captures:
              <<: *heading-captures
          - name: heading.4.org
            match: "{{headlineLevel4Regex}}"
            captures:
              <<: *heading-captures
          - name: heading.5.org
            match: "{{headlineLevel5Regex}}"
            captures:
              <<: *heading-captures
          - name: heading.6.org
            match: "{{headlineLevel6Regex}}"
            captures:
              <<: *heading-captures
  #endregion HEADLINES

  #region LISTS
  # New rule for the '::' separator within a list item
  list-description-separator:
    match: "{{descriptionSeparatorRegex}}"
    captures:
      1: { name: entity.name.tag.description.term.org } # The term
      2: { name: punctuation.separator.key-value.org }    # The '::' separator

  # New rule for the [@NN] counter within an ordered list item
  list-counter:
    match: "{{listCounterRegex}}"
    name: constant.numeric.list-counter.org # The whole [@NN] construct
    captures:
      1: { name: constant.numeric.value.org } # The number NN

  lists:
    patterns:
      # Unordered lists (which can contain description lists)
      - name: markup.list.unnumbered.org
        begin: "{{unorderedListRegex}}"
        end: "(?=$)"
        beginCaptures:
          1: { name: string.other.whitespace.leading.org }
          2: { name: punctuation.definition.list.begin.org }
          3: { name: constant.language.checkbox.org }
        patterns:
          - { include: '#list-description-separator' } # Include the separator rule
          - { include: '#inline-markup' }
      # Ordered lists
      - name: markup.list.numbered.org
        begin: "{{orderedListRegex}}"
        end: "(?=$)"
        beginCaptures:
          1: { name: string.other.whitespace.leading.org }
          2: { name: punctuation.definition.list.begin.org }
          3: { name: constant.language.checkbox.org }
        patterns:
          - { include: '#list-counter' } # Include the counter rule
          - { include: '#inline-markup' }
  #endregion LISTS

  # org-block-base structure definition (YAML anchor, content reuse only)
  org-block-base: &org-block-base
    beginCaptures: { "0": { name: punctuation.definition.raw.begin.org } }
    endCaptures: { "0": { name: punctuation.definition.raw.end.org } }
    patterns:
      - include: "#inline-markup"

  # org-src-blocks auto-generated by build-grammar.ts
  org-src-blocks:
    patterns:
      # SRC block language definitions will be auto-generated by the build script
      # For any language not in the list, a fallback pattern will match and highlight the block generically.
      - "{{srcBlockDefinitions}}"

  # org-special-blocks reuse org-block-base
  org-special-blocks:
    patterns:
      - <<: *org-block-base
        name: markup.raw.block.org
        begin: "{{quoteBlockBeginRegex}}"
        end: "{{quoteBlockEndRegex}}"
      - <<: *org-block-base
        name: markup.raw.block.org
        begin: "{{exampleBlockBeginRegex}}"
        end: "{{exampleBlockEndRegex}}"
      - <<: *org-block-base
        name: markup.raw.block.org
        begin: "{{verseBlockBeginRegex}}"
        end: "{{verseBlockEndRegex}}"
      - <<: *org-block-base
        name: markup.raw.block.org
        begin: "{{centerBlockBeginRegex}}"
        end: "{{centerBlockEndRegex}}"
      - <<: *org-block-base
        name: markup.raw.block.org
        begin: "{{commentBlockBeginRegex}}"
        end: "{{commentBlockEndRegex}}"

  keywords:
    patterns:
      - name: meta.keyword.option.org
        match: "{{keywordRegex}}"
        captures:
          1: { name: keyword.other.org }
          2: { name: entity.name.function.option.org }
          3: { name: string.unquoted.value.org }

  drawers:
    name: meta.drawer.org
    begin: "{{drawerBeginRegex}}"
    end: "{{drawerEndRegex}}"
    beginCaptures:
      0: { name: punctuation.definition.drawer.begin.org }
      1: { name: entity.name.function.drawer.org }
    endCaptures:
      0: { name: punctuation.definition.drawer.end.org }

  tables:
    name: markup.table.org
    match: "{{tableRegex}}"

  horizontal-rules:
    name: markup.other.horizontal-rule.org
    match: "{{horizontalRuleRegex}}"

  footnotes:
    patterns:
      - name: meta.footnote.definition.org
        match: "{{footnoteDefinitionRegex}}"
      - name: meta.footnote.reference.org
        match: "{{footnoteReferenceRegex}}"

  paragraph:
    begin: "{{paragraphBeginRegex}}"
    end: "{{paragraphEndRegex}}"
    patterns:
      - include: "#inline-markup"

  inline-markup:
    patterns:
      - include: "#links"
      - include: "#timestamps-active"
      - include: "#timestamps-inactive"
      - include: "#latex"
      - include: "#bold"
      - include: "#italic"
      - include: "#underline"
      - include: "#strikethrough"
      - include: "#code"
      - include: "#verbatim"
      - include: "#entities"
      - include: "#sub-super-scripts"

  links:
    name: meta.link.org
    match: "{{linkRegex}}"
    captures:
      1: { name: punctuation.definition.link.begin.org }
      2: { name: markup.underline.link.org }
      3: { name: string.other.link.description.org }
      4: { name: punctuation.definition.link.end.org }

  timestamps-active:
    name: constant.other.timestamp.active.org
    match: "{{timestampActiveRegex}}"

  timestamps-inactive:
    name: comment.timestamp.inactive.org
    match: "{{timestampInactiveRegex}}"

  latex:
    name: markup.math.org
    match: "{{latexRegex}}"

  bold:
    name: markup.bold.org
    match: "{{boldRegex}}"

  italic:
    name: markup.italic.org
    match: "{{italicRegex}}"

  underline:
    name: markup.underline.org
    match: "{{underlineRegex}}"

  strikethrough:
    name: markup.strikethrough.org
    match: "{{strikethroughRegex}}"

  code:
    name: markup.inline.raw.org
    match: "{{codeRegex}}"

  verbatim:
    name: markup.inline.raw.org
    match: "{{verbatimRegex}}"

  entities:
    name: constant.character.entity.org
    match: "{{entitiesRegex}}"

  sub-super-scripts:
    name: markup.other.sub-super-script.org
    match: "{{subSuperScriptRegex}}"
