#+TITLE: Test Suite for Dynamic Blocks

#+NAME: Simple clocktable block with content
#+BEGIN_FIXTURE
#+BEGIN: clocktable :maxlevel 2
Some clocktable content here.
And another line.
#+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+BEGIN:       |
| 3       | clocktable     |
| 4       | :maxlevel 2   |

#+EXPECTED: :type regex :name dynamicBlockEndRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+END:         |

#+NAME: Agenda block with content and parameters
#+BEGIN_FIXTURE
#+BEGIN: agenda :files "agenda.org" :span 1w
- TODO Task 1
- DONE Task 2
#+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+BEGIN:       |
| 3       | agenda         |
| 4       | :files "agenda.org" :span 1w |

#+EXPECTED: :type regex :name dynamicBlockEndRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+END:         |

#+NAME: Indented columnview block with content
#+BEGIN_FIXTURE
  #+BEGIN: columnview :maxlevel 3
  * Task 1
  * Task 2
  #+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       | <sp:2>         |
| 2       | #+BEGIN:       |
| 3       | columnview     |
| 4       | :maxlevel 3   |

#+EXPECTED: :type regex :name dynamicBlockEndRegex
| Group # | Expected Value |
|---------+----------------|
| 1       | <sp:2>         |
| 2       | #+END:         |

#+NAME: Block with no parameters and no content
#+BEGIN_FIXTURE
#+BEGIN: custom
#+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+BEGIN:       |
| 3       | custom         |
| 4       |                |

#+EXPECTED: :type regex :name dynamicBlockEndRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+END:         |

#+NAME: Case-insensitivity test
#+BEGIN_FIXTURE
#+bEgIn: ClOcKtAbLe
#+eNd:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+bEgIn:       |
| 3       | ClOcKtAbLe     |
| 4       |                |

#+EXPECTED: :type regex :name dynamicBlockEndRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+eNd:         |

#+NAME: Malformed BEGIN line should not match
#+BEGIN_FIXTURE
#+BEGIN clocktable
#+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
no-match

#+NAME: Malformed END line should not match
#+BEGIN_FIXTURE
#+BEGIN: clocktable
#+END
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockEndRegex
no-match

#+NAME: Unit Test: Dynamic block parameter with quoted value
#+BEGIN_FIXTURE
:files "agenda.org"
#+END_FIXTURE

#+EXPECTED: :type regex :name blockParameterRegex
| Group # | Expected Value |
|---------+----------------|
| 1       | :files         |
| 2       | "agenda.org"   |

#+NAME: Malformed END line with extra text should not match
#+BEGIN_FIXTURE
#+BEGIN: clocktable
#+END: extra
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockEndRegex
no-match

#+NAME: Parameter with no value
#+BEGIN_FIXTURE
#+BEGIN: agenda :files
#+END:
#+END_FIXTURE

#+EXPECTED: :type regex :name dynamicBlockBeginRegex
| Group # | Expected Value |
|---------+----------------|
| 1       |                |
| 2       | #+BEGIN:       |
| 3       | agenda         |
| 4       | :files         |

#+NAME: Show Case - scope assertions for dynamic blocks
#+BEGIN_FIXTURE
#+BEGIN: clocktable :maxlevel 2
Some dynamic content
#+END:
#+END_FIXTURE
#+EXPECTED: :type scope
"#+BEGIN: clocktable :maxlevel 2" => {{scopes.DYNAMIC_BLOCK_META}}
  - "#+BEGIN:" => {{scopes.BLOCK_KEYWORD}}
  - ":maxlevel" => {{scopes.BLOCK_PARAMETER_KEY}}
  - "2" => {{scopes.BLOCK_PARAMETER_VALUE}}
"Some dynamic content" => {{scopes.DYNAMIC_BLOCK_CONTENT}}
"#+END:" => {{scopes.BLOCK_KEYWORD}}
